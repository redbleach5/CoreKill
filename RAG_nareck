#!/usr/bin/env python3
"""
–°–∫—Ä–∏–ø—Ç –¥–ª—è –ø–æ–ª–Ω–æ–π –æ—á–∏—Å—Ç–∫–∏ –ø—Ä–æ–µ–∫—Ç–∞ (RAG_nareck).

–û—á–∏—â–∞–µ—Ç –≤—Å–µ –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã, –∫—ç—à–∏, –ª–æ–≥–∏, –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –∏ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã
–¥–ª—è –æ—Ç–ª–∞–¥–∫–∏ –∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è.

–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:
    python3 RAG_nareck
    –∏–ª–∏
    ./RAG_nareck
"""

import os
import shutil
import sys
from pathlib import Path


def print_header(text: str):
    """–í—ã–≤–æ–¥–∏—Ç –∑–∞–≥–æ–ª–æ–≤–æ–∫."""
    print(f"\n{'='*60}")
    print(f"  {text}")
    print(f"{'='*60}\n")


def remove_path(path: Path, description: str):
    """–£–¥–∞–ª—è–µ—Ç –ø—É—Ç—å —Å –≤—ã–≤–æ–¥–æ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏."""
    if path.exists():
        if path.is_file():
            size = path.stat().st_size
            path.unlink()
            print(f"  ‚úÖ –£–¥–∞–ª—ë–Ω —Ñ–∞–π–ª: {path} ({size:,} –±–∞–π—Ç)")
        elif path.is_dir():
            # –ü–æ–¥—Å—á–∏—Ç—ã–≤–∞–µ–º —Ä–∞–∑–º–µ—Ä –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
            total_size = sum(f.stat().st_size for f in path.rglob('*') if f.is_file())
            file_count = sum(1 for _ in path.rglob('*') if _.is_file())
            shutil.rmtree(path)
            print(f"  ‚úÖ –£–¥–∞–ª–µ–Ω–∞ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è: {path} ({file_count} —Ñ–∞–π–ª–æ–≤, {total_size:,} –±–∞–π—Ç)")
        return True
    else:
        print(f"  ‚ÑπÔ∏è  –ù–µ –Ω–∞–π–¥–µ–Ω: {path}")
        return False


def main():
    """–û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –æ—á–∏—Å—Ç–∫–∏."""
    print_header("üßπ RAG_nareck - –ü–æ–ª–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞")
    
    # –ü–æ–ª—É—á–∞–µ–º –∫–æ—Ä–Ω–µ–≤—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –ø—Ä–æ–µ–∫—Ç–∞
    project_root = Path(__file__).parent.resolve()
    os.chdir(project_root)
    
    print(f"üìÅ –†–∞–±–æ—á–∞—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è: {project_root}\n")
    
    removed_count = 0
    total_size = 0
    
    # 1. –õ–æ–≥–∏
    print_header("üìã –û—á–∏—Å—Ç–∫–∞ –ª–æ–≥–æ–≤")
    log_dirs = [
        project_root / "logs",
    ]
    for log_dir in log_dirs:
        if remove_path(log_dir, "–õ–æ–≥–∏"):
            removed_count += 1
    
    # 2. –ö—ç—à–∏ –∏ –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã
    print_header("üóëÔ∏è  –û—á–∏—Å—Ç–∫–∞ –∫—ç—à–µ–π –∏ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤")
    cache_paths = [
        project_root / ".pytest_cache",
        project_root / ".mypy_cache",
        project_root / ".ruff_cache",
        project_root / ".coverage",
        project_root / "htmlcov",
        project_root / "coverage.json",
        project_root / ".context_cache",
        project_root / "temp",
        project_root / "__pycache__",
    ]
    for cache_path in cache_paths:
        if remove_path(cache_path, "–ö—ç—à"):
            removed_count += 1
    
    # 3. –ë–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –∏ RAG
    print_header("üíæ –û—á–∏—Å—Ç–∫–∞ –±–∞–∑ –¥–∞–Ω–Ω—ã—Ö –∏ RAG")
    db_paths = [
        project_root / ".chromadb",
        project_root / ".chromadb_test",
        project_root / ".task_checkpoints",
    ]
    for db_path in db_paths:
        if remove_path(db_path, "–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö"):
            removed_count += 1
    
    # 4. RAG –∏ —Å–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–∏–µ –∏–Ω–¥–µ–∫—Å—ã
    print_header("üîç –û—á–∏—Å—Ç–∫–∞ RAG –∏ —Å–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–∏—Ö –∏–Ω–¥–µ–∫—Å–æ–≤")
    rag_paths = [
        project_root / ".chromadb",  # ChromaDB –¥–ª—è RAG
        project_root / ".context_cache",  # –ö—ç—à –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–≥–æ –¥–≤–∏–∂–∫–∞
    ]
    # –¢–∞–∫–∂–µ –∏—â–µ–º –≤—Å–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ —Å chroma –≤ –Ω–∞–∑–≤–∞–Ω–∏–∏
    for rag_path in project_root.rglob("*chroma*"):
        if rag_path.is_dir() and rag_path not in db_paths:
            if remove_path(rag_path, "RAG –∏–Ω–¥–µ–∫—Å"):
                removed_count += 1
    
    # –û—á–∏—â–∞–µ–º –∫—ç—à –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–≥–æ –¥–≤–∏–∂–∫–∞ (—Å–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–∏–µ –∏–Ω–¥–µ–∫—Å—ã)
    context_cache = project_root / ".context_cache"
    if remove_path(context_cache, "–°–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–∏–π –∏–Ω–¥–µ–∫—Å"):
        removed_count += 1
    
    # 5. Output –∏ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã
    print_header("üì¶ –û—á–∏—Å—Ç–∫–∞ output –∏ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–æ–≤")
    output_paths = [
        project_root / "output",
        project_root / "test_results",
        project_root / "generated_code.py",
        project_root / "generated_tests.py",
    ]
    for output_path in output_paths:
        if remove_path(output_path, "Output"):
            removed_count += 1
    
    # 6. Python –∫—ç—à–∏
    print_header("üêç –û—á–∏—Å—Ç–∫–∞ Python –∫—ç—à–µ–π")
    pycache_count = 0
    for pycache_dir in project_root.rglob("__pycache__"):
        if remove_path(pycache_dir, "Python –∫—ç—à"):
            pycache_count += 1
    if pycache_count == 0:
        print("  ‚ÑπÔ∏è  Python –∫—ç—à–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã")
    
    # 7. .pyc —Ñ–∞–π–ª—ã
    print_header("üîç –û—á–∏—Å—Ç–∫–∞ .pyc —Ñ–∞–π–ª–æ–≤")
    pyc_count = 0
    for pyc_file in project_root.rglob("*.pyc"):
        if remove_path(pyc_file, ".pyc —Ñ–∞–π–ª"):
            pyc_count += 1
    if pyc_count == 0:
        print("  ‚ÑπÔ∏è  .pyc —Ñ–∞–π–ª—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã")
    
    # 8. –í—Ä–µ–º–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã –ø—Ä–æ–µ–∫—Ç–∞
    print_header("üìù –û—á–∏—Å—Ç–∫–∞ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤")
    temp_files = [
        project_root / "fix1.txt",
        project_root / "fix2.txt",
        project_root / "dependency_analysis.json",
    ]
    for temp_file in temp_files:
        if remove_path(temp_file, "–í—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª"):
            removed_count += 1
    
    # 9. Frontend –∫—ç—à–∏ –∏ build
    print_header("‚öõÔ∏è  –û—á–∏—Å—Ç–∫–∞ Frontend –∫—ç—à–µ–π")
    frontend_paths = [
        project_root / "frontend" / "node_modules",
        project_root / "frontend" / "dist",
        project_root / "frontend" / "build",
        project_root / "frontend" / ".cache",
    ]
    for frontend_path in frontend_paths:
        if remove_path(frontend_path, "Frontend –∫—ç—à"):
            removed_count += 1
    
    # 10. –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ RAG –∫–æ–ª–ª–µ–∫—Ü–∏–π
    print_header("üßπ –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ RAG")
    # –ò—â–µ–º –≤—Å–µ –≤–æ–∑–º–æ–∂–Ω—ã–µ –º–µ—Å—Ç–∞ —Ö—Ä–∞–Ω–µ–Ω–∏—è RAG –¥–∞–Ω–Ω—ã—Ö
    additional_rag_paths = [
        project_root / "output" / "chromadb",
        project_root / "output" / "rag",
        project_root / "output" / "vector_db",
    ]
    for rag_path in additional_rag_paths:
        if remove_path(rag_path, "RAG –¥–∞–Ω–Ω—ã–µ"):
            removed_count += 1
    
    # 11. IDE –∫—ç—à–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –º–æ–∂–Ω–æ –∑–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å)
    print_header("üíª –û—á–∏—Å—Ç–∫–∞ IDE –∫—ç—à–µ–π (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)")
    ide_paths = [
        project_root / ".vscode" / ".ropeproject",
        project_root / ".idea" / "workspace.xml",
    ]
    for ide_path in ide_paths:
        if ide_path.exists():
            print(f"  ‚ö†Ô∏è  –ü—Ä–æ–ø—É—â–µ–Ω IDE —Ñ–∞–π–ª: {ide_path} (–º–æ–∂–Ω–æ —É–¥–∞–ª–∏—Ç—å –≤—Ä—É—á–Ω—É—é)")
    
    # –ò—Ç–æ–≥–∏
    print_header("‚úÖ –û—á–∏—Å—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞")
    print(f"  üìä –£–¥–∞–ª–µ–Ω–æ —ç–ª–µ–º–µ–Ω—Ç–æ–≤: {removed_count}")
    print(f"  üí° –ü—Ä–æ–µ–∫—Ç –≥–æ—Ç–æ–≤ –∫ –æ—Ç–ª–∞–¥–∫–µ!")
    print(f"\n  ‚ö†Ô∏è  –í–ù–ò–ú–ê–ù–ò–ï: –£–¥–∞–ª–µ–Ω—ã –≤—Å–µ –ª–æ–≥–∏, –∫—ç—à–∏ –∏ –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã.")
    print(f"  üí° –î–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π:")
    print(f"     - Python: pip install -r requirements.txt")
    print(f"     - Frontend: cd frontend && npm install")
    print()


if __name__ == "__main__":
    try:
        main()
    except KeyboardInterrupt:
        print("\n\n‚ö†Ô∏è  –û—á–∏—Å—Ç–∫–∞ –ø—Ä–µ—Ä–≤–∞–Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º")
        sys.exit(1)
    except Exception as e:
        print(f"\n\n‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—á–∏—Å—Ç–∫–µ: {e}")
        import traceback
        traceback.print_exc()
        sys.exit(1)
