"""ChatAgent Ğ´Ğ»Ñ Ğ¿Ñ€Ğ¾ÑÑ‚Ğ¾Ğ³Ğ¾ Ğ´Ğ¸Ğ°Ğ»Ğ¾Ğ³Ğ¾Ğ²Ğ¾Ğ³Ğ¾ Ğ²Ğ·Ğ°Ğ¸Ğ¼Ğ¾Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ñ Ñ LLM.

ĞĞ±ĞµÑĞ¿ĞµÑ‡Ğ¸Ğ²Ğ°ĞµÑ‚ Ñ€ĞµĞ¶Ğ¸Ğ¼ Ñ‡Ğ°Ñ‚Ğ° Ğ±ĞµĞ· Ğ·Ğ°Ğ¿ÑƒÑĞºĞ° Ğ¿Ğ¾Ğ»Ğ½Ğ¾Ğ³Ğ¾ workflow.
ĞŸĞ¾Ğ´Ğ´ĞµÑ€Ğ¶Ğ¸Ğ²Ğ°ĞµÑ‚ ĞºĞ¾Ğ½Ñ‚ĞµĞºÑÑ‚ Ğ´Ğ¸Ğ°Ğ»Ğ¾Ğ³Ğ° Ğ¸ Ñ€Ğ°Ğ·Ğ»Ğ¸Ñ‡Ğ½Ñ‹Ğµ ÑÑ‚Ğ¸Ğ»Ğ¸ Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ñ.

ĞÑĞ¾Ğ±ĞµĞ½Ğ½Ğ¾ÑÑ‚Ğ¸:
- ĞšÑÑˆĞ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ¾Ñ‚Ğ²ĞµÑ‚Ğ¾Ğ² Ğ½Ğ° Ñ‚Ğ¸Ğ¿Ğ¾Ğ²Ñ‹Ğµ Ğ²Ğ¾Ğ¿Ñ€Ğ¾ÑÑ‹ (FAQ)
- ĞŸĞ¾Ğ´Ğ´ĞµÑ€Ğ¶ĞºĞ° Ğ¸ÑÑ‚Ğ¾Ñ€Ğ¸Ğ¸ Ğ´Ğ¸Ğ°Ğ»Ğ¾Ğ³Ğ°
- Ğ Ğ°Ğ·Ğ»Ğ¸Ñ‡Ğ½Ñ‹Ğµ ÑÑ‚Ğ¸Ğ»Ğ¸ Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ñ
- ĞĞ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸Ğ¹ Ğ²ĞµĞ±-Ğ¿Ğ¾Ğ¸ÑĞº Ğ´Ğ»Ñ Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ¾Ğ², Ñ‚Ñ€ĞµĞ±ÑƒÑÑ‰Ğ¸Ñ… Ğ°ĞºÑ‚ÑƒĞ°Ğ»ÑŒĞ½Ğ¾Ğ¹ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ğ¸
"""
import hashlib
from datetime import datetime
from typing import Optional, List, Dict, Any
from dataclasses import dataclass
from infrastructure.local_llm import create_llm_for_stage
from infrastructure.cache import get_cache
from infrastructure.web_search import web_search
from infrastructure.ast_analyzer import ProjectAnalyzer, analyze_code_structure
from utils.logger import get_logger


logger = get_logger()

# Ğ’Ñ€ĞµĞ¼Ñ Ğ¶Ğ¸Ğ·Ğ½Ğ¸ ĞºÑÑˆĞ° Ğ´Ğ»Ñ chat Ğ¾Ñ‚Ğ²ĞµÑ‚Ğ¾Ğ² (1 Ñ‡Ğ°Ñ)
CHAT_CACHE_TTL = 3600


@dataclass
class ChatResponse:
    """ĞÑ‚Ğ²ĞµÑ‚ ChatAgent."""
    content: str
    tokens_used: int = 0
    model_used: str = ""
    finish_reason: str = "stop"


class ChatAgent:
    """ĞĞ³ĞµĞ½Ñ‚ Ğ´Ğ»Ñ Ğ¿Ñ€Ğ¾ÑÑ‚Ğ¾Ğ³Ğ¾ Ğ´Ğ¸Ğ°Ğ»Ğ¾Ğ³Ğ¾Ğ²Ğ¾Ğ³Ğ¾ Ğ²Ğ·Ğ°Ğ¸Ğ¼Ğ¾Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ñ.
    
    Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµÑ‚ÑÑ Ğ´Ğ»Ñ Ñ€ĞµĞ¶Ğ¸Ğ¼Ğ° chat, ĞºĞ¾Ğ³Ğ´Ğ° Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ Ñ…Ğ¾Ñ‡ĞµÑ‚ Ğ¿Ñ€Ğ¾ÑÑ‚Ğ¾
    Ğ¿Ğ¾Ğ³Ğ¾Ğ²Ğ¾Ñ€Ğ¸Ñ‚ÑŒ Ñ LLM Ğ±ĞµĞ· Ğ·Ğ°Ğ¿ÑƒÑĞºĞ° Ğ¿Ğ¾Ğ»Ğ½Ğ¾Ğ³Ğ¾ workflow Ğ³ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ğ¸ ĞºĞ¾Ğ´Ğ°.
    
    ĞŸĞ¾Ğ´Ğ´ĞµÑ€Ğ¶Ğ¸Ğ²Ğ°ĞµÑ‚:
    - Ğ”Ğ¸Ğ°Ğ»Ğ¾Ğ³ Ñ ĞºĞ¾Ğ½Ñ‚ĞµĞºÑÑ‚Ğ¾Ğ¼ Ğ¸ÑÑ‚Ğ¾Ñ€Ğ¸Ğ¸
    - ĞÑ‚Ğ²ĞµÑ‚Ñ‹ Ğ½Ğ° Ğ²Ğ¾Ğ¿Ñ€Ğ¾ÑÑ‹ Ğ¾ ĞºĞ¾Ğ´Ğµ
    - ĞĞ±ÑÑƒĞ¶Ğ´ĞµĞ½Ğ¸Ğµ Ğ°Ñ€Ñ…Ğ¸Ñ‚ĞµĞºÑ‚ÑƒÑ€Ñ‹
    - ĞĞ±ÑŠÑÑĞ½ĞµĞ½Ğ¸Ñ ĞºĞ¾Ğ½Ñ†ĞµĞ¿Ñ†Ğ¸Ğ¹
    """
    
    SYSTEM_PROMPT = """Ğ¢Ñ‹ â€” Ğ¾Ğ¿Ñ‹Ñ‚Ğ½Ñ‹Ğ¹ senior Ñ€Ğ°Ğ·Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‡Ğ¸Ğº Ğ¸ Ğ¿Ğ¾Ğ¼Ğ¾Ñ‰Ğ½Ğ¸Ğº Ğ¿Ğ¾ Ğ¿Ñ€Ğ¾Ğ³Ñ€Ğ°Ğ¼Ğ¼Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ.

## Ğ¢Ğ²Ğ¾Ğ¸ Ñ…Ğ°Ñ€Ğ°ĞºÑ‚ĞµÑ€Ğ¸ÑÑ‚Ğ¸ĞºĞ¸:
- ĞÑ‚Ğ²ĞµÑ‡Ğ°ĞµÑˆÑŒ Ğ½Ğ° Ñ€ÑƒÑÑĞºĞ¾Ğ¼ ÑĞ·Ñ‹ĞºĞµ
- Ğ”Ğ°Ñ‘ÑˆÑŒ Ñ‡Ñ‘Ñ‚ĞºĞ¸Ğµ Ğ¸ ÑÑ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¾Ñ‚Ğ²ĞµÑ‚Ñ‹
- Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµÑˆÑŒ markdown Ğ´Ğ»Ñ Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ
- Ğ•ÑĞ»Ğ¸ Ğ²Ğ¾Ğ¿Ñ€Ğ¾Ñ Ğ½ĞµÑÑĞµĞ½ â€” ÑƒÑ‚Ğ¾Ñ‡Ğ½ÑĞµÑˆÑŒ

## ĞŸÑ€Ğ°Ğ²Ğ¸Ğ»Ğ° Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ:
- Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞ¹ **Ğ¶Ğ¸Ñ€Ğ½Ñ‹Ğ¹** Ğ´Ğ»Ñ Ğ²Ğ°Ğ¶Ğ½Ñ‹Ñ… Ñ‚ĞµÑ€Ğ¼Ğ¸Ğ½Ğ¾Ğ²
- Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞ¹ `ĞºĞ¾Ğ´` Ğ´Ğ»Ñ Ğ¸Ğ¼Ñ‘Ğ½ Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ğ¹, Ğ¿ĞµÑ€ĞµĞ¼ĞµĞ½Ğ½Ñ‹Ñ…, ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´
- Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞ¹ ÑĞ¿Ğ¸ÑĞºĞ¸ Ğ´Ğ»Ñ Ğ¿ĞµÑ€ĞµÑ‡Ğ¸ÑĞ»ĞµĞ½Ğ¸Ğ¹
- Ğ¡ÑÑ‹Ğ»ĞºĞ¸ Ğ¾Ñ„Ğ¾Ñ€Ğ¼Ğ»ÑĞ¹ ĞºĞ°Ğº [Ñ‚ĞµĞºÑÑ‚](url)
- Ğ Ğ°Ğ·Ğ´ĞµĞ»ÑĞ¹ Ñ€Ğ°Ğ·Ğ´ĞµĞ»Ñ‹ Ğ·Ğ°Ğ³Ğ¾Ğ»Ğ¾Ğ²ĞºĞ°Ğ¼Ğ¸ ## Ğ¸Ğ»Ğ¸ ###
- Ğ‘Ğ»Ğ¾ĞºĞ¸ ĞºĞ¾Ğ´Ğ° Ğ¾Ğ±Ñ€Ğ°Ğ¼Ğ»ÑĞ¹ Ñ‚Ñ€Ğ¾Ğ¹Ğ½Ñ‹Ğ¼Ğ¸ backticks Ñ ÑƒĞºĞ°Ğ·Ğ°Ğ½Ğ¸ĞµĞ¼ ÑĞ·Ñ‹ĞºĞ°

## Ğ Ğ°Ğ±Ğ¾Ñ‚Ğ° Ñ Ğ°ĞºÑ‚ÑƒĞ°Ğ»ÑŒĞ½Ğ¾Ğ¹ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸ĞµĞ¹:
- Ğ•ÑĞ»Ğ¸ Ğ² ĞºĞ¾Ğ½Ñ‚ĞµĞºÑÑ‚Ğµ ĞµÑÑ‚ÑŒ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¸Ğ· Ğ²ĞµĞ±-Ğ¿Ğ¾Ğ¸ÑĞºĞ° â€” Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞ¹ Ğ˜Ğ¥ Ğ´Ğ»Ñ Ğ¾Ñ‚Ğ²ĞµÑ‚Ğ°
- ĞĞ• Ğ²Ñ‹Ğ´ÑƒĞ¼Ñ‹Ğ²Ğ°Ğ¹ Ğ½Ğ¾Ğ²Ğ¾ÑÑ‚Ğ¸, ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ñ, Ğ´Ğ°Ñ‚Ñ‹ â€” Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ñ‚Ğ¾, Ñ‡Ñ‚Ğ¾ ĞµÑÑ‚ÑŒ Ğ² ĞºĞ¾Ğ½Ñ‚ĞµĞºÑÑ‚Ğµ
- Ğ•ÑĞ»Ğ¸ ĞºĞ¾Ğ½Ñ‚ĞµĞºÑÑ‚Ğ° Ğ½ĞµĞ´Ğ¾ÑÑ‚Ğ°Ñ‚Ğ¾Ñ‡Ğ½Ğ¾ â€” Ñ‡ĞµÑÑ‚Ğ½Ğ¾ ÑĞºĞ°Ğ¶Ğ¸, Ñ‡Ñ‚Ğ¾ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ğ¸ Ğ½ĞµÑ‚
- Ğ£ĞºĞ°Ğ·Ñ‹Ğ²Ğ°Ğ¹ Ğ¸ÑÑ‚Ğ¾Ñ‡Ğ½Ğ¸ĞºĞ¸ ĞµÑĞ»Ğ¸ Ğ¾Ğ½Ğ¸ ĞµÑÑ‚ÑŒ Ğ² ĞºĞ¾Ğ½Ñ‚ĞµĞºÑÑ‚Ğµ

## Ğ ĞµĞ¶Ğ¸Ğ¼ Ğ´Ğ¸Ğ°Ğ»Ğ¾Ğ³Ğ° â€” Ñ‡Ñ‚Ğ¾ Ñ‚Ñ‹ Ğ”Ğ•Ğ›ĞĞ•Ğ¨Ğ¬:
- ĞÑ‚Ğ²ĞµÑ‡Ğ°ĞµÑˆÑŒ Ğ½Ğ° Ğ²Ğ¾Ğ¿Ñ€Ğ¾ÑÑ‹ Ğ¾ Ğ¿Ñ€Ğ¾Ğ³Ñ€Ğ°Ğ¼Ğ¼Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğ¸
- ĞĞ±ÑŠÑÑĞ½ÑĞµÑˆÑŒ ĞºĞ¾Ğ½Ñ†ĞµĞ¿Ñ†Ğ¸Ğ¸, Ğ¿Ğ°Ñ‚Ñ‚ĞµÑ€Ğ½Ñ‹, Ğ¿Ğ¾Ğ´Ñ…Ğ¾Ğ´Ñ‹
- ĞĞ±ÑÑƒĞ¶Ğ´Ğ°ĞµÑˆÑŒ Ğ°Ñ€Ñ…Ğ¸Ñ‚ĞµĞºÑ‚ÑƒÑ€Ñƒ Ğ¸ Ğ´Ğ¸Ğ·Ğ°Ğ¹Ğ½
- ĞŸĞ¾Ğ¼Ğ¾Ğ³Ğ°ĞµÑˆÑŒ Ñ€Ğ°Ğ·Ğ¾Ğ±Ñ€Ğ°Ñ‚ÑŒÑÑ Ğ² Ñ‡ÑƒĞ¶Ğ¾Ğ¼ ĞºĞ¾Ğ´Ğµ
- Ğ”Ğ°Ñ‘ÑˆÑŒ ÑĞ¾Ğ²ĞµÑ‚Ñ‹ Ğ¸ Ñ€ĞµĞºĞ¾Ğ¼ĞµĞ½Ğ´Ğ°Ñ†Ğ¸Ğ¸
- ĞŸĞ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµÑˆÑŒ ĞšĞĞ ĞĞ¢ĞšĞ˜Ğ• Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€Ñ‹ ĞºĞ¾Ğ´Ğ° (Ğ´Ğ¾ 20-30 ÑÑ‚Ñ€Ğ¾Ğº) Ğ´Ğ»Ñ Ğ¸Ğ»Ğ»ÑÑÑ‚Ñ€Ğ°Ñ†Ğ¸Ğ¸

## Ğ ĞµĞ¶Ğ¸Ğ¼ Ğ´Ğ¸Ğ°Ğ»Ğ¾Ğ³Ğ° â€” Ñ‡Ñ‚Ğ¾ Ñ‚Ñ‹ ĞĞ• Ğ´ĞµĞ»Ğ°ĞµÑˆÑŒ:
- ĞĞ• Ğ³ĞµĞ½ĞµÑ€Ğ¸Ñ€ÑƒĞµÑˆÑŒ Ğ¿Ğ¾Ğ»Ğ½Ğ¾Ñ†ĞµĞ½Ğ½Ñ‹Ğµ Ğ¿Ñ€Ğ¾Ğ³Ñ€Ğ°Ğ¼Ğ¼Ñ‹ Ğ¸ ÑĞºÑ€Ğ¸Ğ¿Ñ‚Ñ‹
- ĞĞ• ÑĞ¾Ğ·Ğ´Ğ°Ñ‘ÑˆÑŒ Ğ³Ğ¾Ñ‚Ğ¾Ğ²Ñ‹Ğ¹ Ğº Ğ·Ğ°Ğ¿ÑƒÑĞºÑƒ ĞºĞ¾Ğ´ Ñ Ğ¿Ğ¾Ğ»Ğ½Ğ¾Ğ¹ Ğ»Ğ¾Ğ³Ğ¸ĞºĞ¾Ğ¹
- ĞĞ• Ğ¿Ğ¸ÑˆĞµÑˆÑŒ Ñ‚ĞµÑÑ‚Ñ‹ (ÑÑ‚Ğ¾ Ğ´ĞµĞ»Ğ°ĞµÑ‚ Ñ€ĞµĞ¶Ğ¸Ğ¼ "Ğ“ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ñ ĞºĞ¾Ğ´Ğ°")
- ĞĞ• Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½ÑĞµÑˆÑŒ TDD workflow
- ĞĞ• Ğ²Ñ‹Ğ´ÑƒĞ¼Ñ‹Ğ²Ğ°Ğ¹ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ, ĞºĞ¾Ñ‚Ğ¾Ñ€Ğ¾Ğ¹ Ğ½ĞµÑ‚ Ğ² ĞºĞ¾Ğ½Ñ‚ĞµĞºÑÑ‚Ğµ

## ĞšĞ¾Ğ³Ğ´Ğ° Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ Ğ¿Ñ€Ğ¾ÑĞ¸Ñ‚ Ğ½Ğ°Ğ¿Ğ¸ÑĞ°Ñ‚ÑŒ Ğ¿Ğ¾Ğ»Ğ½Ğ¾Ñ†ĞµĞ½Ğ½Ñ‹Ğ¹ ĞºĞ¾Ğ´:
Ğ•ÑĞ»Ğ¸ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ Ğ¿Ñ€Ğ¾ÑĞ¸Ñ‚ ÑĞ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ñ, ĞºĞ»Ğ°ÑÑ, ÑĞºÑ€Ğ¸Ğ¿Ñ‚ Ğ¸Ğ»Ğ¸ Ğ¿Ñ€Ğ¾Ğ³Ñ€Ğ°Ğ¼Ğ¼Ñƒ â€” 
Ğ²ĞµĞ¶Ğ»Ğ¸Ğ²Ğ¾ Ğ¾Ğ±ÑŠÑÑĞ½Ğ¸, Ñ‡Ñ‚Ğ¾ Ğ´Ğ»Ñ Ğ³ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ğ¸ ĞºĞ°Ñ‡ĞµÑÑ‚Ğ²ĞµĞ½Ğ½Ğ¾Ğ³Ğ¾ ĞºĞ¾Ğ´Ğ° Ñ Ñ‚ĞµÑÑ‚Ğ°Ğ¼Ğ¸ Ğ¸ Ğ²Ğ°Ğ»Ğ¸Ğ´Ğ°Ñ†Ğ¸ĞµĞ¹
Ğ»ÑƒÑ‡ÑˆĞµ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ñ€ĞµĞ¶Ğ¸Ğ¼ **"Ğ“ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ñ ĞºĞ¾Ğ´Ğ°"** (Ğ¸ĞºĞ¾Ğ½ĞºĞ° Code Ğ² Ğ½Ğ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ°Ñ… Ñ€ĞµĞ¶Ğ¸Ğ¼Ğ°).

Ğ’ Ñ€ĞµĞ¶Ğ¸Ğ¼Ğµ Ğ´Ğ¸Ğ°Ğ»Ğ¾Ğ³Ğ° Ñ‚Ñ‹ Ğ¼Ğ¾Ğ¶ĞµÑˆÑŒ Ğ¿Ğ¾ĞºĞ°Ğ·Ğ°Ñ‚ÑŒ Ğ¾Ğ±Ñ‰ÑƒÑ ÑÑ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ñƒ Ğ¸Ğ»Ğ¸ Ğ¿ÑĞµĞ²Ğ´Ğ¾ĞºĞ¾Ğ´,
Ğ½Ğ¾ Ğ¿Ğ¾Ğ»Ğ½Ğ¾Ñ†ĞµĞ½Ğ½ÑƒÑ Ñ€ĞµĞ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ Ğ´ĞµĞ»Ğ°ĞµÑ‚ ÑĞ¿ĞµÑ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğ¹ workflow."""

    def __init__(
        self,
        model: Optional[str] = None,
        temperature: float = 0.3,
        max_tokens: int = 2048
    ):
        """Ğ˜Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ¸Ñ€ÑƒĞµÑ‚ ChatAgent.
        
        Args:
            model: ĞœĞ¾Ğ´ĞµĞ»ÑŒ Ollama (None = Ğ°Ğ²Ñ‚Ğ¾Ğ²Ñ‹Ğ±Ğ¾Ñ€)
            temperature: Ğ¢ĞµĞ¼Ğ¿ĞµÑ€Ğ°Ñ‚ÑƒÑ€Ğ° Ğ³ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ğ¸ (Ğ²Ñ‹ÑˆĞµ Ğ´Ğ»Ñ ĞºÑ€ĞµĞ°Ñ‚Ğ¸Ğ²Ğ½Ğ¾ÑÑ‚Ğ¸)
            max_tokens: ĞœĞ°ĞºÑĞ¸Ğ¼ÑƒĞ¼ Ñ‚Ğ¾ĞºĞµĞ½Ğ¾Ğ² Ğ² Ğ¾Ñ‚Ğ²ĞµÑ‚Ğµ
        """
        self.llm = create_llm_for_stage(
            stage="chat",
            model=model or "auto",
            temperature=temperature,
            top_p=0.9
        )
        self.max_tokens = max_tokens
        self.temperature = temperature
        self.model = model
        # ĞšÑÑˆ Ğ´Ğ»Ñ Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚Ğ¾Ğ² Ğ¾Ğ¿Ñ€ĞµĞ´ĞµĞ»ĞµĞ½Ğ¸Ñ Ğ½ĞµĞ¾Ğ±Ñ…Ğ¾Ğ´Ğ¸Ğ¼Ğ¾ÑÑ‚Ğ¸ Ğ²ĞµĞ±-Ğ¿Ğ¾Ğ¸ÑĞºĞ°
        self._web_search_cache: Dict[str, bool] = {}
        logger.info(f"âœ… ChatAgent Ğ¸Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½ (Ğ¼Ğ¾Ğ´ĞµĞ»ÑŒ: {model or 'auto'})")
    
    def _get_cache_key(self, message: str, history_len: int) -> str:
        """Ğ“ĞµĞ½ĞµÑ€Ğ¸Ñ€ÑƒĞµÑ‚ ĞºĞ»ÑÑ‡ ĞºÑÑˆĞ° Ğ´Ğ»Ñ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ñ.
        
        ĞšÑÑˆ ÑƒÑ‡Ğ¸Ñ‚Ñ‹Ğ²Ğ°ĞµÑ‚ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ Ğ±ĞµĞ· Ğ¸ÑÑ‚Ğ¾Ñ€Ğ¸Ğ¸ Ğ´Ğ»Ñ Ñ‚Ğ¸Ğ¿Ğ¾Ğ²Ñ‹Ñ… Ğ²Ğ¾Ğ¿Ñ€Ğ¾ÑĞ¾Ğ².
        Ğ•ÑĞ»Ğ¸ ĞµÑÑ‚ÑŒ Ğ¸ÑÑ‚Ğ¾Ñ€Ğ¸Ñ â€” ĞºÑÑˆ Ğ½Ğµ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµÑ‚ÑÑ.
        
        Args:
            message: Ğ¡Ğ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ
            history_len: Ğ”Ğ»Ğ¸Ğ½Ğ° Ğ¸ÑÑ‚Ğ¾Ñ€Ğ¸Ğ¸ Ğ´Ğ¸Ğ°Ğ»Ğ¾Ğ³Ğ°
            
        Returns:
            ĞšĞ»ÑÑ‡ ĞºÑÑˆĞ° Ğ¸Ğ»Ğ¸ Ğ¿ÑƒÑÑ‚Ğ°Ñ ÑÑ‚Ñ€Ğ¾ĞºĞ° ĞµÑĞ»Ğ¸ ĞºÑÑˆĞ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ½Ğµ Ğ¿Ñ€Ğ¸Ğ¼ĞµĞ½Ğ¸Ğ¼Ğ¾
        """
        # ĞšÑÑˆĞ¸Ñ€ÑƒĞµĞ¼ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ¿ĞµÑ€Ğ²Ñ‹Ğµ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ñ (Ğ±ĞµĞ· Ğ¸ÑÑ‚Ğ¾Ñ€Ğ¸Ğ¸)
        if history_len > 0:
            return ""
        
        # ĞĞ¾Ñ€Ğ¼Ğ°Ğ»Ğ¸Ğ·ÑƒĞµĞ¼ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ
        normalized = message.lower().strip()
        
        # ĞšÑÑˆĞ¸Ñ€ÑƒĞµĞ¼ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ ĞºĞ¾Ñ€Ğ¾Ñ‚ĞºĞ¸Ğµ Ñ‚Ğ¸Ğ¿Ğ¾Ğ²Ñ‹Ğµ Ğ²Ğ¾Ğ¿Ñ€Ğ¾ÑÑ‹
        if len(normalized) > 200:
            return ""
        
        return f"chat:{hashlib.md5(normalized.encode()).hexdigest()}"
    
    def chat(
        self,
        message: str,
        conversation_history: Optional[List[Dict[str, str]]] = None,
        system_prompt: Optional[str] = None,
        use_cache: bool = True,
        disable_web_search: bool = False
    ) -> ChatResponse:
        """ĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµÑ‚ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ Ğ¸ Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ°ĞµÑ‚ Ğ¾Ñ‚Ğ²ĞµÑ‚.
        
        Args:
            message: Ğ¡Ğ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ
            conversation_history: Ğ˜ÑÑ‚Ğ¾Ñ€Ğ¸Ñ Ğ´Ğ¸Ğ°Ğ»Ğ¾Ğ³Ğ° [{role, content}]
            system_prompt: ĞšĞ°ÑÑ‚Ğ¾Ğ¼Ğ½Ñ‹Ğ¹ ÑĞ¸ÑÑ‚ĞµĞ¼Ğ½Ñ‹Ğ¹ Ğ¿Ñ€Ğ¾Ğ¼Ğ¿Ñ‚ (Ğ¾Ğ¿Ñ†Ğ¸Ğ¾Ğ½Ğ°Ğ»ÑŒĞ½Ğ¾)
            use_cache: Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ÑŒ ĞºÑÑˆ Ğ´Ğ»Ñ Ñ‚Ğ¸Ğ¿Ğ¾Ğ²Ñ‹Ñ… Ğ²Ğ¾Ğ¿Ñ€Ğ¾ÑĞ¾Ğ²
            
        Returns:
            ChatResponse Ñ Ğ¾Ñ‚Ğ²ĞµÑ‚Ğ¾Ğ¼
        """
        history_len = len(conversation_history) if conversation_history else 0
        
        # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼, Ñ‚Ñ€ĞµĞ±ÑƒĞµÑ‚ Ğ»Ğ¸ Ğ·Ğ°Ğ¿Ñ€Ğ¾Ñ Ğ°ĞºÑ‚ÑƒĞ°Ğ»ÑŒĞ½Ğ¾Ğ¹ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ğ¸ (Ğ½Ğ¾Ğ²Ğ¾ÑÑ‚Ğ¸, Ğ¿Ğ¾Ğ³Ğ¾Ğ´Ğ° Ğ¸ Ñ‚.Ğ´.)
        # Ğ”Ğ»Ñ Ñ‚Ğ°ĞºĞ¸Ñ… Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ¾Ğ² ĞºÑÑˆ Ğ½Ğµ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµÑ‚ÑÑ
        needs_realtime = self._needs_realtime_info(message)
        
        # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ ĞºÑÑˆ Ğ´Ğ»Ñ Ñ‚Ğ¸Ğ¿Ğ¾Ğ²Ñ‹Ñ… Ğ²Ğ¾Ğ¿Ñ€Ğ¾ÑĞ¾Ğ² (Ğ½Ğµ Ğ´Ğ»Ñ realtime Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ¾Ğ²)
        cache_key = ""
        if use_cache and not needs_realtime:
            cache_key = self._get_cache_key(message, history_len)
            if cache_key:
                cache = get_cache()
                cached_response = cache.get(cache_key)
                if cached_response:
                    logger.info(f"ğŸ’¾ ChatAgent: Ğ¾Ñ‚Ğ²ĞµÑ‚ Ğ¸Ğ· ĞºÑÑˆĞ° ({len(cached_response)} ÑĞ¸Ğ¼Ğ²Ğ¾Ğ»Ğ¾Ğ²)")
                    return ChatResponse(
                        content=cached_response,
                        model_used=self.llm.model or "",
                        finish_reason="cached"
                    )
        
        # Ğ˜Ğ¡ĞŸĞ ĞĞ’Ğ›Ğ•ĞĞ˜Ğ•: Ğ•ÑĞ»Ğ¸ Ğ·Ğ°Ğ¿Ñ€Ğ¾Ñ Ñ‚Ñ€ĞµĞ±ÑƒĞµÑ‚ Ğ°ĞºÑ‚ÑƒĞ°Ğ»ÑŒĞ½Ğ¾Ğ¹ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ğ¸ â€” Ğ´ĞµĞ»Ğ°ĞµĞ¼ Ğ²ĞµĞ±-Ğ¿Ğ¾Ğ¸ÑĞº
        # (ĞµÑĞ»Ğ¸ Ğ²ĞµĞ±-Ğ¿Ğ¾Ğ¸ÑĞº Ğ½Ğµ Ğ¾Ñ‚ĞºĞ»ÑÑ‡ĞµĞ½ ÑĞ²Ğ½Ğ¾)
        web_context = ""
        if needs_realtime and not disable_web_search:
            web_context = self._fetch_realtime_context(message)
        elif needs_realtime and disable_web_search:
            logger.info("â„¹ï¸ Ğ’ĞµĞ±-Ğ¿Ğ¾Ğ¸ÑĞº Ğ¾Ñ‚ĞºĞ»ÑÑ‡ĞµĞ½ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¼, Ğ¿Ñ€Ğ¾Ğ¿ÑƒÑĞºĞ°ĞµĞ¼")
        
        # Ğ¤Ğ¾Ñ€Ğ¼Ğ¸Ñ€ÑƒĞµĞ¼ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ñ Ğ² Ğ½Ğ°Ñ‚Ğ¸Ğ²Ğ½Ğ¾Ğ¼ Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ğµ Ğ´Ğ»Ñ ollama.chat()
        messages = self._build_messages(
            message=message,
            history=conversation_history,
            system_prompt=system_prompt or self.SYSTEM_PROMPT,
            web_context=web_context
        )
        
        logger.info(f"ğŸ’¬ ChatAgent: Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ° ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ñ ({len(message)} ÑĞ¸Ğ¼Ğ²Ğ¾Ğ»Ğ¾Ğ²)")
        
        try:
            # Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ Ğ½Ğ°Ñ‚Ğ¸Ğ²Ğ½Ñ‹Ğ¹ chat API â€” Ğ¼Ğ¾Ğ´ĞµĞ»ÑŒ ÑĞ°Ğ¼Ğ° Ğ¿Ñ€Ğ¸Ğ¼ĞµĞ½Ğ¸Ñ‚ Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»ÑŒĞ½Ñ‹Ğ¹ ÑˆĞ°Ğ±Ğ»Ğ¾Ğ½ Ğ¸ stop-Ñ‚Ğ¾ĞºĞµĞ½Ñ‹
            response = self.llm.chat(messages=messages)
            
            logger.info(f"âœ… ChatAgent: Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½ Ğ¾Ñ‚Ğ²ĞµÑ‚ ({len(response)} ÑĞ¸Ğ¼Ğ²Ğ¾Ğ»Ğ¾Ğ²)")
            
            # Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ÑĞµĞ¼ Ğ² ĞºÑÑˆ ĞµÑĞ»Ğ¸ ÑÑ‚Ğ¾ Ñ‚Ğ¸Ğ¿Ğ¾Ğ²Ğ¾Ğ¹ Ğ²Ğ¾Ğ¿Ñ€Ğ¾Ñ
            if cache_key and response:
                cache = get_cache()
                cache.set(cache_key, response, ttl=CHAT_CACHE_TTL)
                logger.debug(f"ğŸ’¾ ChatAgent: Ğ¾Ñ‚Ğ²ĞµÑ‚ ÑĞ¾Ñ…Ñ€Ğ°Ğ½Ñ‘Ğ½ Ğ² ĞºÑÑˆ")
            
            return ChatResponse(
                content=response,
                model_used=self.llm.model or "",
                finish_reason="stop"
            )
            
        except Exception as e:
            logger.error(f"âŒ ChatAgent Ğ¾ÑˆĞ¸Ğ±ĞºĞ°: {e}", error=e)
            return ChatResponse(
                content=f"ĞŸÑ€Ğ¾Ğ¸Ğ·Ğ¾ÑˆĞ»Ğ° Ğ¾ÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ Ğ³ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ğ¸ Ğ¾Ñ‚Ğ²ĞµÑ‚Ğ°: {str(e)}",
                finish_reason="error"
            )
    
    def _build_messages(
        self,
        message: str,
        history: Optional[List[Dict[str, str]]],
        system_prompt: str,
        web_context: str = ""
    ) -> List[Dict[str, str]]:
        """Ğ¤Ğ¾Ñ€Ğ¼Ğ¸Ñ€ÑƒĞµÑ‚ ÑĞ¿Ğ¸ÑĞ¾Ğº ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğ¹ Ğ´Ğ»Ñ Ğ½Ğ°Ñ‚Ğ¸Ğ²Ğ½Ğ¾Ğ³Ğ¾ chat API.
        
        Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµÑ‚ ÑÑ‚Ğ°Ğ½Ğ´Ğ°Ñ€Ñ‚Ğ½Ñ‹Ğ¹ Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚ Ollama chat API:
        [{"role": "system/user/assistant", "content": "..."}]
        
        ĞœĞ¾Ğ´ĞµĞ»ÑŒ ÑĞ°Ğ¼Ğ° Ğ¿Ñ€Ğ¸Ğ¼ĞµĞ½Ğ¸Ñ‚ Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»ÑŒĞ½Ñ‹Ğ¹ ÑˆĞ°Ğ±Ğ»Ğ¾Ğ½ (Gemma, Llama, etc.)
        Ğ¸ stop-Ñ‚Ğ¾ĞºĞµĞ½Ñ‹. Ğ­Ñ‚Ğ¾ Ğ¸ÑĞºĞ»ÑÑ‡Ğ°ĞµÑ‚ Ğ¿Ñ€Ğ¾Ğ±Ğ»ĞµĞ¼Ñ‹ Ñ ĞºĞ°ÑÑ‚Ğ¾Ğ¼Ğ½Ğ¾Ğ¹ Ñ€Ğ°Ğ·Ğ¼ĞµÑ‚ĞºĞ¾Ğ¹.
        
        Args:
            message: Ğ¢ĞµĞºÑƒÑ‰ĞµĞµ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ
            history: Ğ˜ÑÑ‚Ğ¾Ñ€Ğ¸Ñ Ğ´Ğ¸Ğ°Ğ»Ğ¾Ğ³Ğ°
            system_prompt: Ğ¡Ğ¸ÑÑ‚ĞµĞ¼Ğ½Ñ‹Ğ¹ Ğ¿Ñ€Ğ¾Ğ¼Ğ¿Ñ‚
            web_context: ĞšĞ¾Ğ½Ñ‚ĞµĞºÑÑ‚ Ğ¸Ğ· Ğ²ĞµĞ±-Ğ¿Ğ¾Ğ¸ÑĞºĞ° (Ğ´Ğ»Ñ realtime Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ¾Ğ²)
            
        Returns:
            Ğ¡Ğ¿Ğ¸ÑĞ¾Ğº ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğ¹ Ğ´Ğ»Ñ ollama.chat()
        """
        messages: List[Dict[str, str]] = []
        
        # Ğ¡Ğ¸ÑÑ‚ĞµĞ¼Ğ½Ñ‹Ğ¹ Ğ¿Ñ€Ğ¾Ğ¼Ğ¿Ñ‚ Ñ Ğ²ĞµĞ±-ĞºĞ¾Ğ½Ñ‚ĞµĞºÑÑ‚Ğ¾Ğ¼ ĞµÑĞ»Ğ¸ ĞµÑÑ‚ÑŒ
        full_system = system_prompt
        if web_context:
            today = datetime.now().strftime("%d %B %Y")
            full_system += f"\n\n---\nĞ¡ĞµĞ³Ğ¾Ğ´Ğ½ÑÑˆĞ½ÑÑ Ğ´Ğ°Ñ‚Ğ°: {today}\n\nĞĞºÑ‚ÑƒĞ°Ğ»ÑŒĞ½Ğ°Ñ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ Ğ¸Ğ· Ğ²ĞµĞ±-Ğ¿Ğ¾Ğ¸ÑĞºĞ°:\n{web_context}"
        
        messages.append({"role": "system", "content": full_system})
        
        # Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ Ğ¸ÑÑ‚Ğ¾Ñ€Ğ¸Ñ Ğ´Ğ¸Ğ°Ğ»Ğ¾Ğ³Ğ°
        if history:
            for msg in history:
                role = msg.get("role", "user")
                content = msg.get("content", "")
                # Ollama chat API Ğ¿Ğ¾Ğ´Ğ´ĞµÑ€Ğ¶Ğ¸Ğ²Ğ°ĞµÑ‚ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ user/assistant/system
                if role in ("user", "assistant"):
                    messages.append({"role": role, "content": content})
        
        # Ğ¢ĞµĞºÑƒÑ‰ĞµĞµ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ
        messages.append({"role": "user", "content": message})
        
        return messages
    
    def _needs_realtime_info(self, message: str) -> bool:
        """ĞĞ¿Ñ€ĞµĞ´ĞµĞ»ÑĞµÑ‚, Ñ‚Ñ€ĞµĞ±ÑƒĞµÑ‚ Ğ»Ğ¸ Ğ·Ğ°Ğ¿Ñ€Ğ¾Ñ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ğ¸ Ğ¸Ğ· Ğ¸Ğ½Ñ‚ĞµÑ€Ğ½ĞµÑ‚Ğ°.
        
        Ğ˜Ğ¡ĞŸĞ ĞĞ’Ğ›Ğ•ĞĞ˜Ğ•: Ğ£Ğ¿Ñ€Ğ¾Ñ‰ĞµĞ½Ğ½Ğ°Ñ Ğ»Ğ¾Ğ³Ğ¸ĞºĞ° Ğ±ĞµĞ· Ğ¼ĞµĞ´Ğ»ĞµĞ½Ğ½Ñ‹Ñ… LLM Ğ²Ñ‹Ğ·Ğ¾Ğ²Ğ¾Ğ².
        Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµÑ‚ Ğ±Ñ‹ÑÑ‚Ñ€ÑƒÑ ÑĞ²Ñ€Ğ¸ÑÑ‚Ğ¸ĞºÑƒ, ĞºĞ¾Ñ‚Ğ¾Ñ€Ğ°Ñ Ğ¿Ğ¾ĞºÑ€Ñ‹Ğ²Ğ°ĞµÑ‚ Ğ±Ğ¾Ğ»ÑŒÑˆĞ¸Ğ½ÑÑ‚Ğ²Ğ¾ ÑĞ»ÑƒÑ‡Ğ°ĞµĞ².
        
        Args:
            message: Ğ¡Ğ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ
            
        Returns:
            True ĞµÑĞ»Ğ¸ Ğ½ÑƒĞ¶ĞµĞ½ Ğ²ĞµĞ±-Ğ¿Ğ¾Ğ¸ÑĞº
        """
        if not message or not message.strip():
            return False
        
        message_lower = message.lower().strip()
        words = message_lower.split()
        
        # 1. Ğ‘Ñ‹ÑÑ‚Ñ€Ğ°Ñ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ´Ğ»Ñ ÑĞ²Ğ½Ñ‹Ñ… ÑĞ»ÑƒÑ‡Ğ°ĞµĞ² Ğ°ĞºÑ‚ÑƒĞ°Ğ»ÑŒĞ½Ğ¾Ğ¹ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ğ¸ (Ğ½Ğ¾Ğ²Ğ¾ÑÑ‚Ğ¸, Ğ¿Ğ¾Ğ³Ğ¾Ğ´Ğ°)
        realtime_keywords = [
            "Ğ½Ğ¾Ğ²Ğ¾ÑÑ‚", "ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸", "ÑĞµĞ³Ğ¾Ğ´Ğ½Ñ", "Ğ²Ñ‡ĞµÑ€Ğ°", "ÑĞµĞ¹Ñ‡Ğ°Ñ", "Ğ¿Ğ¾ÑĞ»ĞµĞ´Ğ½",
            "Ğ°ĞºÑ‚ÑƒĞ°Ğ»ÑŒĞ½", "ÑĞ²ĞµĞ¶Ğ¸", "Ñ‚ĞµĞºÑƒÑ‰", "Ğ¿Ğ¾Ğ³Ğ¾Ğ´", "ĞºÑƒÑ€Ñ Ğ²Ğ°Ğ»ÑÑ‚", "Ğ±Ğ¸Ñ‚ĞºĞ¾Ğ¸Ğ½",
            "news", "today", "yesterday", "current", "latest", "weather", "stock"
        ]
        
        for keyword in realtime_keywords:
            if keyword in message_lower:
                logger.info(f"ğŸŒ ĞĞ±Ğ½Ğ°Ñ€ÑƒĞ¶ĞµĞ½ Ğ·Ğ°Ğ¿Ñ€Ğ¾Ñ Ğ°ĞºÑ‚ÑƒĞ°Ğ»ÑŒĞ½Ğ¾Ğ¹ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ğ¸: {keyword}")
                return True
        
        # 2. ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼, ÑĞ²Ğ»ÑĞµÑ‚ÑÑ Ğ»Ğ¸ ÑÑ‚Ğ¾ Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ¾Ğ¼ Ğ¾ ĞºĞ¾Ğ´Ğµ - ĞµÑĞ»Ğ¸ Ğ´Ğ°, Ğ²ĞµĞ±-Ğ¿Ğ¾Ğ¸ÑĞº Ğ½Ğµ Ğ½ÑƒĞ¶ĞµĞ½
        code_keywords = [
            "ĞºĞ¾Ğ´", "Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ñ", "ĞºĞ»Ğ°ÑÑ", "Ğ¼Ğ¾Ğ´ÑƒĞ»ÑŒ", "ÑĞºÑ€Ğ¸Ğ¿Ñ‚", "Ğ¿Ñ€Ğ¾Ğ³Ñ€Ğ°Ğ¼Ğ¼Ğ°", "Ğ°Ğ»Ğ³Ğ¾Ñ€Ğ¸Ñ‚Ğ¼",
            "code", "function", "class", "module", "script", "program", "algorithm",
            "Ğ½Ğ°Ğ¿Ğ¸ÑˆĞ¸", "ÑĞ¾Ğ·Ğ´Ğ°Ğ¹", "ÑĞ´ĞµĞ»Ğ°Ğ¹", "write", "create", "make", "build",
            "def ", "import", "print", "return", "async", "await", "python", "javascript"
        ]
        
        has_code_keyword = any(kw in message_lower for kw in code_keywords)
        if has_code_keyword:
            return False
        
        # 3. ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼, ÑĞ²Ğ»ÑĞµÑ‚ÑÑ Ğ»Ğ¸ ÑÑ‚Ğ¾ Ğ²Ğ¾Ğ¿Ñ€Ğ¾ÑĞ¾Ğ¼ Ğ¸Ğ»Ğ¸ ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ğ¾Ğ¹ Ñ€Ğ°ÑÑĞºĞ°Ğ·Ğ°Ñ‚ÑŒ/Ğ¾Ğ¿Ğ¸ÑĞ°Ñ‚ÑŒ
        question_indicators = ["?", "Ğ·Ğ½Ğ°ĞµÑˆÑŒ", "Ñ€Ğ°ÑÑĞºĞ°Ğ¶Ğ¸", "Ñ‡Ñ‚Ğ¾ Ñ‚Ğ°ĞºĞ¾Ğµ", "ĞºÑ‚Ğ¾ Ñ‚Ğ°ĞºĞ¾Ğ¹", 
                              "ĞºĞ¾Ğ³Ğ´Ğ°", "Ğ³Ğ´Ğµ", "ĞºĞ°ĞºĞ¾Ğ¹", "do you know", "tell me", 
                              "what is", "who is", "when", "where", "which", "how"]
        
        tell_commands = ["Ñ€Ğ°ÑÑĞºĞ°Ğ¶Ğ¸", "Ğ¾Ğ¿Ğ¸ÑˆĞ¸", "Ğ¾Ğ±ÑŠÑÑĞ½Ğ¸", "tell", "describe", "explain"]
        
        has_question = any(indicator in message_lower for indicator in question_indicators)
        has_tell_command = any(cmd in message_lower for cmd in tell_commands)
        
        # 4. Ğ•ÑĞ»Ğ¸ ÑÑ‚Ğ¾ Ğ²Ğ¾Ğ¿Ñ€Ğ¾Ñ Ğ¸Ğ»Ğ¸ ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ğ° Ñ€Ğ°ÑÑĞºĞ°Ğ·Ğ°Ñ‚ÑŒ Ğ‘Ğ•Ğ— ĞºĞ»ÑÑ‡ĞµĞ²Ñ‹Ñ… ÑĞ»Ğ¾Ğ² ĞºĞ¾Ğ´Ğ°,
        # Ğ¸ Ğ·Ğ°Ğ¿Ñ€Ğ¾Ñ Ğ½Ğµ ÑĞ»Ğ¸ÑˆĞºĞ¾Ğ¼ ĞºĞ¾Ñ€Ğ¾Ñ‚ĞºĞ¸Ğ¹ (Ğ±Ğ¾Ğ»ÑŒÑˆĞµ 2 ÑĞ»Ğ¾Ğ²) - Ğ½ÑƒĞ¶ĞµĞ½ Ğ²ĞµĞ±-Ğ¿Ğ¾Ğ¸ÑĞº
        if (has_question or has_tell_command) and len(words) > 2:
            # Ğ˜ÑĞºĞ»ÑÑ‡Ğ°ĞµĞ¼ Ğ¿Ñ€Ğ¾ÑÑ‚Ñ‹Ğµ Ğ¿Ñ€Ğ¸Ğ²ĞµÑ‚ÑÑ‚Ğ²Ğ¸Ñ Ñ Ğ²Ğ¾Ğ¿Ñ€Ğ¾ÑĞ°Ğ¼Ğ¸ "ĞºĞ°Ğº Ğ´ĞµĞ»Ğ°"
            simple_greeting_questions = ["ĞºĞ°Ğº Ğ´ĞµĞ»Ğ°", "how are you", "ĞºĞ°Ğº Ğ¿Ğ¾Ğ¶Ğ¸Ğ²Ğ°ĞµÑˆÑŒ", "what's up", "ĞºĞ°Ğº Ğ¶Ğ¸Ğ·Ğ½ÑŒ"]
            is_simple_greeting = any(greeting in message_lower for greeting in simple_greeting_questions)
            
            if not is_simple_greeting:
                logger.info(f"ğŸŒ ĞĞ±Ğ½Ğ°Ñ€ÑƒĞ¶ĞµĞ½ Ğ²Ğ¾Ğ¿Ñ€Ğ¾Ñ/ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ğ° Ñ€Ğ°ÑÑĞºĞ°Ğ·Ğ°Ñ‚ÑŒ (Ğ½Ğµ Ğ¾ ĞºĞ¾Ğ´Ğµ, {len(words)} ÑĞ»Ğ¾Ğ²) - Ğ²ĞºĞ»ÑÑ‡Ğ°ĞµĞ¼ Ğ²ĞµĞ±-Ğ¿Ğ¾Ğ¸ÑĞº")
                return True
        
        return False
    
    def _fetch_realtime_context(self, message: str) -> str:
        """Ğ’Ñ‹Ğ¿Ğ¾Ğ»Ğ½ÑĞµÑ‚ Ğ²ĞµĞ±-Ğ¿Ğ¾Ğ¸ÑĞº Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ñ Ğ°ĞºÑ‚ÑƒĞ°Ğ»ÑŒĞ½Ğ¾Ğ¹ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ğ¸.
        
        Args:
            message: Ğ—Ğ°Ğ¿Ñ€Ğ¾Ñ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ
            
        Returns:
            Ğ¤Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğ¹ ĞºĞ¾Ğ½Ñ‚ĞµĞºÑÑ‚ Ğ¸Ğ· Ğ²ĞµĞ±-Ğ¿Ğ¾Ğ¸ÑĞºĞ° Ğ¸Ğ»Ğ¸ Ğ¿ÑƒÑÑ‚Ğ°Ñ ÑÑ‚Ñ€Ğ¾ĞºĞ°
        """
        try:
            logger.info(f"ğŸŒ Ğ’Ñ‹Ğ¿Ğ¾Ğ»Ğ½ÑÑ Ğ²ĞµĞ±-Ğ¿Ğ¾Ğ¸ÑĞº Ğ´Ğ»Ñ: {message[:50]}...")
            
            # Ğ¤Ğ¾Ñ€Ğ¼Ğ¸Ñ€ÑƒĞµĞ¼ Ğ¿Ğ¾Ğ¸ÑĞºĞ¾Ğ²Ñ‹Ğ¹ Ğ·Ğ°Ğ¿Ñ€Ğ¾Ñ
            # Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ Ñ‚ĞµĞºÑƒÑ‰ÑƒÑ Ğ´Ğ°Ñ‚Ñƒ Ğ´Ğ»Ñ Ğ»ÑƒÑ‡ÑˆĞ¸Ñ… Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚Ğ¾Ğ²
            today = datetime.now().strftime("%Y")
            search_query = f"{message} {today}"
            
            results = web_search(search_query, max_results=4, timeout=10)
            
            if not results:
                logger.warning("âš ï¸ Ğ’ĞµĞ±-Ğ¿Ğ¾Ğ¸ÑĞº Ğ½Ğµ Ğ²ĞµÑ€Ğ½ÑƒĞ» Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚Ğ¾Ğ²")
                return ""
            
            logger.info(f"âœ… ĞŸĞ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¾ {len(results)} Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚Ğ¾Ğ² Ğ²ĞµĞ±-Ğ¿Ğ¾Ğ¸ÑĞºĞ°")
            
            # Ğ¤Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ğ¸Ñ€ÑƒĞµĞ¼ Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚Ñ‹
            formatted_parts = []
            for i, result in enumerate(results, 1):
                title = result.get("title", "").strip()
                url = result.get("url", "").strip()
                snippet = result.get("snippet", "").strip()
                
                if snippet:
                    if title:
                        formatted_parts.append(f"{i}. **{title}**")
                    formatted_parts.append(f"   {snippet}")
                    if url:
                        formatted_parts.append(f"   Ğ˜ÑÑ‚Ğ¾Ñ‡Ğ½Ğ¸Ğº: {url}")
                    formatted_parts.append("")
            
            return "\n".join(formatted_parts).strip()
            
        except Exception as e:
            logger.error(f"âŒ ĞÑˆĞ¸Ğ±ĞºĞ° Ğ²ĞµĞ±-Ğ¿Ğ¾Ğ¸ÑĞºĞ°: {e}", error=e)
            return ""
    
    def explain_code(self, code: str, question: Optional[str] = None) -> ChatResponse:
        """ĞĞ±ÑŠÑÑĞ½ÑĞµÑ‚ ĞºĞ¾Ğ´.
        
        Args:
            code: ĞšĞ¾Ğ´ Ğ´Ğ»Ñ Ğ¾Ğ±ÑŠÑÑĞ½ĞµĞ½Ğ¸Ñ
            question: ĞšĞ¾Ğ½ĞºÑ€ĞµÑ‚Ğ½Ñ‹Ğ¹ Ğ²Ğ¾Ğ¿Ñ€Ğ¾Ñ Ğ¾ ĞºĞ¾Ğ´Ğµ (Ğ¾Ğ¿Ñ†Ğ¸Ğ¾Ğ½Ğ°Ğ»ÑŒĞ½Ğ¾)
            
        Returns:
            ChatResponse Ñ Ğ¾Ğ±ÑŠÑÑĞ½ĞµĞ½Ğ¸ĞµĞ¼
        """
        prompt = f"ĞĞ±ÑŠÑÑĞ½Ğ¸ ÑĞ»ĞµĞ´ÑƒÑÑ‰Ğ¸Ğ¹ ĞºĞ¾Ğ´:\n\n```\n{code}\n```"
        if question:
            prompt += f"\n\nĞšĞ¾Ğ½ĞºÑ€ĞµÑ‚Ğ½Ñ‹Ğ¹ Ğ²Ğ¾Ğ¿Ñ€Ğ¾Ñ: {question}"
        
        return self.chat(
            message=prompt,
            system_prompt="""Ğ¢Ñ‹ â€” ÑĞºÑĞ¿ĞµÑ€Ñ‚ Ğ¿Ğ¾ ĞºĞ¾Ğ´Ñƒ. ĞĞ±ÑŠÑÑĞ½ÑĞ¹ ĞºĞ¾Ğ´ Ñ‡Ñ‘Ñ‚ĞºĞ¾ Ğ¸ Ğ¿Ğ¾Ğ½ÑÑ‚Ğ½Ğ¾:
1. Ğ§Ñ‚Ğ¾ Ğ´ĞµĞ»Ğ°ĞµÑ‚ ĞºĞ¾Ğ´ Ğ² Ñ†ĞµĞ»Ğ¾Ğ¼
2. ĞšĞ»ÑÑ‡ĞµĞ²Ñ‹Ğµ Ñ‡Ğ°ÑÑ‚Ğ¸ Ğ¸ Ğ¸Ñ… Ğ½Ğ°Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ğµ
3. Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼Ñ‹Ğµ Ğ¿Ğ°Ñ‚Ñ‚ĞµÑ€Ğ½Ñ‹ Ğ¸ Ğ¿Ğ¾Ğ´Ñ…Ğ¾Ğ´Ñ‹
4. Ğ’Ğ¾Ğ·Ğ¼Ğ¾Ğ¶Ğ½Ñ‹Ğµ ÑƒĞ»ÑƒÑ‡ÑˆĞµĞ½Ğ¸Ñ (ĞµÑĞ»Ğ¸ ĞµÑÑ‚ÑŒ)

ĞÑ‚Ğ²ĞµÑ‡Ğ°Ğ¹ Ğ½Ğ° Ñ€ÑƒÑÑĞºĞ¾Ğ¼ ÑĞ·Ñ‹ĞºĞµ."""
        )
    
    def discuss_architecture(
        self,
        description: str,
        context: Optional[str] = None
    ) -> ChatResponse:
        """ĞĞ±ÑÑƒĞ¶Ğ´Ğ°ĞµÑ‚ Ğ°Ñ€Ñ…Ğ¸Ñ‚ĞµĞºÑ‚ÑƒÑ€Ñƒ Ğ¸Ğ»Ğ¸ Ğ¿Ğ¾Ğ´Ñ…Ğ¾Ğ´.
        
        Args:
            description: ĞĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ¸ Ğ¸Ğ»Ğ¸ Ğ°Ñ€Ñ…Ğ¸Ñ‚ĞµĞºÑ‚ÑƒÑ€Ñ‹
            context: Ğ”Ğ¾Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ñ‹Ğ¹ ĞºĞ¾Ğ½Ñ‚ĞµĞºÑÑ‚ (Ğ¾Ğ¿Ñ†Ğ¸Ğ¾Ğ½Ğ°Ğ»ÑŒĞ½Ğ¾)
            
        Returns:
            ChatResponse Ñ Ñ€ĞµĞºĞ¾Ğ¼ĞµĞ½Ğ´Ğ°Ñ†Ğ¸ÑĞ¼Ğ¸
        """
        prompt = f"ĞĞ±ÑÑƒĞ´Ğ¸Ğ¼ Ğ°Ñ€Ñ…Ğ¸Ñ‚ĞµĞºÑ‚ÑƒÑ€Ñƒ/Ğ¿Ğ¾Ğ´Ñ…Ğ¾Ğ´:\n\n{description}"
        if context:
            prompt += f"\n\nĞšĞ¾Ğ½Ñ‚ĞµĞºÑÑ‚:\n{context}"
        
        return self.chat(
            message=prompt,
            system_prompt="""Ğ¢Ñ‹ â€” Ğ°Ñ€Ñ…Ğ¸Ñ‚ĞµĞºÑ‚Ğ¾Ñ€ ĞŸĞ. ĞŸÑ€Ğ¸ Ğ¾Ğ±ÑÑƒĞ¶Ğ´ĞµĞ½Ğ¸Ğ¸ Ğ°Ñ€Ñ…Ğ¸Ñ‚ĞµĞºÑ‚ÑƒÑ€Ñ‹:
1. ĞĞ½Ğ°Ğ»Ğ¸Ğ·Ğ¸Ñ€ÑƒĞ¹ Ñ‚Ñ€ĞµĞ±Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ
2. ĞŸÑ€ĞµĞ´Ğ»Ğ°Ğ³Ğ°Ğ¹ Ğ½ĞµÑĞºĞ¾Ğ»ÑŒĞºĞ¾ Ğ¿Ğ¾Ğ´Ñ…Ğ¾Ğ´Ğ¾Ğ² Ñ Ğ¿Ğ»ÑÑĞ°Ğ¼Ğ¸ Ğ¸ Ğ¼Ğ¸Ğ½ÑƒÑĞ°Ğ¼Ğ¸
3. Ğ ĞµĞºĞ¾Ğ¼ĞµĞ½Ğ´ÑƒĞ¹ Ğ¾Ğ¿Ñ‚Ğ¸Ğ¼Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¹ Ğ²Ğ°Ñ€Ğ¸Ğ°Ğ½Ñ‚ Ñ Ğ¾Ğ±Ğ¾ÑĞ½Ğ¾Ğ²Ğ°Ğ½Ğ¸ĞµĞ¼
4. Ğ£Ñ‡Ğ¸Ñ‚Ñ‹Ğ²Ğ°Ğ¹ Ğ¼Ğ°ÑÑˆÑ‚Ğ°Ğ±Ğ¸Ñ€ÑƒĞµĞ¼Ğ¾ÑÑ‚ÑŒ Ğ¸ Ğ¿Ğ¾Ğ´Ğ´ĞµÑ€Ğ¶Ğ¸Ğ²Ğ°ĞµĞ¼Ğ¾ÑÑ‚ÑŒ

Ğ‘ÑƒĞ´ÑŒ Ğ¿Ñ€Ğ°ĞºÑ‚Ğ¸Ñ‡Ğ½Ñ‹Ğ¼, Ğ¸Ğ·Ğ±ĞµĞ³Ğ°Ğ¹ over-engineering. ĞÑ‚Ğ²ĞµÑ‡Ğ°Ğ¹ Ğ½Ğ° Ñ€ÑƒÑÑĞºĞ¾Ğ¼."""
        )
    
    def quick_help(self, topic: str) -> ChatResponse:
        """Ğ‘Ñ‹ÑÑ‚Ñ€Ğ°Ñ ÑĞ¿Ñ€Ğ°Ğ²ĞºĞ° Ğ¿Ğ¾ Ñ‚ĞµĞ¼Ğµ.
        
        Args:
            topic: Ğ¢ĞµĞ¼Ğ° Ğ´Ğ»Ñ ÑĞ¿Ñ€Ğ°Ğ²ĞºĞ¸
            
        Returns:
            ChatResponse ÑĞ¾ ÑĞ¿Ñ€Ğ°Ğ²ĞºĞ¾Ğ¹
        """
        return self.chat(
            message=f"Ğ”Ğ°Ğ¹ ĞºÑ€Ğ°Ñ‚ĞºÑƒÑ ÑĞ¿Ñ€Ğ°Ğ²ĞºÑƒ Ğ¿Ğ¾: {topic}",
            system_prompt="""Ğ”Ğ°Ñ‘ÑˆÑŒ ĞºÑ€Ğ°Ñ‚ĞºĞ¸Ğµ, Ñ‘Ğ¼ĞºĞ¸Ğµ ÑĞ¿Ñ€Ğ°Ğ²ĞºĞ¸ Ğ¿Ğ¾ Ğ¿Ñ€Ğ¾Ğ³Ñ€Ğ°Ğ¼Ğ¼Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ.
Ğ¤Ğ¾Ñ€Ğ¼Ğ°Ñ‚ Ğ¾Ñ‚Ğ²ĞµÑ‚Ğ°:
- ĞšÑ€Ğ°Ñ‚ĞºĞ¾Ğµ Ğ¾Ğ¿Ñ€ĞµĞ´ĞµĞ»ĞµĞ½Ğ¸Ğµ
- ĞŸÑ€Ğ¸Ğ¼ĞµÑ€ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ (ĞµÑĞ»Ğ¸ ÑƒĞ¼ĞµÑÑ‚Ğ½Ğ¾)
- Ğ¡ÑÑ‹Ğ»ĞºĞ¸ Ğ½Ğ° Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ğ°Ñ†Ğ¸Ñ (ĞµÑĞ»Ğ¸ Ğ·Ğ½Ğ°ĞµÑˆÑŒ)

ĞÑ‚Ğ²ĞµÑ‡Ğ°Ğ¹ Ğ½Ğ° Ñ€ÑƒÑÑĞºĞ¾Ğ¼, ĞºÑ€Ğ°Ñ‚ĞºĞ¾ Ğ¸ Ğ¿Ğ¾ Ğ´ĞµĞ»Ñƒ."""
        )
    
    def analyze_project(
        self,
        task: str,
        codebase_context: str,
        project_path: str
    ) -> ChatResponse:
        """ĞĞ½Ğ°Ğ»Ğ¸Ğ·Ğ¸Ñ€ÑƒĞµÑ‚ Ğ¿Ñ€Ğ¾ĞµĞºÑ‚ Ğ½Ğ° Ğ¾ÑĞ½Ğ¾Ğ²Ğµ ÑĞ¾Ğ±Ñ€Ğ°Ğ½Ğ½Ğ¾Ğ³Ğ¾ ĞºĞ¾Ğ½Ñ‚ĞµĞºÑÑ‚Ğ°.
        
        Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµÑ‚ AST Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ· Ğ´Ğ»Ñ Ñ‚Ğ¾Ñ‡Ğ½Ñ‹Ñ… Ğ¼ĞµÑ‚Ñ€Ğ¸Ğº (Phase 6).
        
        Args:
            task: Ğ˜ÑÑ…Ğ¾Ğ´Ğ½Ñ‹Ğ¹ Ğ·Ğ°Ğ¿Ñ€Ğ¾Ñ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ
            codebase_context: ĞšĞ¾Ğ½Ñ‚ĞµĞºÑÑ‚ Ğ¸Ğ· ĞºĞ¾Ğ´Ğ¾Ğ²Ğ¾Ğ¹ Ğ±Ğ°Ğ·Ñ‹ (Ğ¸Ğ½Ğ´ĞµĞºÑĞ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğµ Ñ„Ğ°Ğ¹Ğ»Ñ‹)
            project_path: ĞŸÑƒÑ‚ÑŒ Ğº Ğ¿Ñ€Ğ¾ĞµĞºÑ‚Ñƒ
            
        Returns:
            ChatResponse Ñ Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ·Ğ¾Ğ¼ Ğ¿Ñ€Ğ¾ĞµĞºÑ‚Ğ°
        """
        # Phase 6: AST Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ· Ğ´Ğ»Ñ Ñ‚Ğ¾Ñ‡Ğ½Ñ‹Ñ… Ğ¼ĞµÑ‚Ñ€Ğ¸Ğº
        ast_report = ""
        try:
            analyzer = ProjectAnalyzer()
            stats = analyzer.analyze_project(project_path)
            
            # Ğ¤Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ğ¸Ñ€ÑƒĞµĞ¼ AST Ğ¼ĞµÑ‚Ñ€Ğ¸ĞºĞ¸
            ast_report = f"""
## ğŸ“Š AST ĞœĞµÑ‚Ñ€Ğ¸ĞºĞ¸ (Ñ‚Ğ¾Ñ‡Ğ½Ñ‹Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ)
- Ğ¤Ğ°Ğ¹Ğ»Ğ¾Ğ² Ğ¿Ñ€Ğ¾Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ·Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¾: {stats['files_analyzed']}
- Ğ¡Ñ‚Ñ€Ğ¾Ğº ĞºĞ¾Ğ´Ğ° (LOC): {stats['total_loc']}
- Ğ¤ÑƒĞ½ĞºÑ†Ğ¸Ğ¹: {stats['total_functions']}
- ĞšĞ»Ğ°ÑÑĞ¾Ğ²: {stats['total_classes']}
- ĞœĞ¾Ğ´ÑƒĞ»ĞµĞ¹ Ğ² Ğ³Ñ€Ğ°Ñ„Ğµ: {stats['dependency_graph']['modules']}
- Ğ¡Ğ²ÑĞ·ĞµĞ¹ (imports): {stats['dependency_graph']['edges']}

### Ğ¡Ğ°Ğ¼Ñ‹Ğµ Ğ²Ğ°Ğ¶Ğ½Ñ‹Ğµ Ğ¼Ğ¾Ğ´ÑƒĞ»Ğ¸:
"""
            for module, importance in stats['most_important_modules'][:5]:
                ast_report += f"- {module} (importance: {importance:.1f})\n"
            
            logger.info(f"ğŸ“Š AST Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ·: {stats['files_analyzed']} Ñ„Ğ°Ğ¹Ğ»Ğ¾Ğ², {stats['total_loc']} LOC")
        except Exception as e:
            logger.debug(f"AST Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ· Ğ¿Ñ€Ğ¾Ğ¿ÑƒÑ‰ĞµĞ½: {e}")
        
        prompt = f"""ĞŸÑ€Ğ¾Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ·Ğ¸Ñ€ÑƒĞ¹ Ğ¿Ñ€Ğ¾ĞµĞºÑ‚ Ğ¸ Ğ´Ğ°Ğ¹ ÑÑ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğ¹ Ğ¾Ğ±Ğ·Ğ¾Ñ€.

ĞŸÑƒÑ‚ÑŒ Ğº Ğ¿Ñ€Ğ¾ĞµĞºÑ‚Ñƒ: {project_path}
{ast_report}

ĞšĞ¾Ğ½Ñ‚ĞµĞºÑÑ‚ ĞºĞ¾Ğ´Ğ¾Ğ²Ğ¾Ğ¹ Ğ±Ğ°Ğ·Ñ‹:
{codebase_context}

Ğ—Ğ°Ğ¿Ñ€Ğ¾Ñ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ: {task}"""

        system_prompt = """Ğ¢Ñ‹ â€” senior Ñ€Ğ°Ğ·Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‡Ğ¸Ğº-Ğ°Ğ½Ğ°Ğ»Ğ¸Ñ‚Ğ¸Ğº. Ğ¢Ğ²Ğ¾Ñ Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ° â€” Ğ´Ğ°Ñ‚ÑŒ ÑÑ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğ¹ Ğ¾Ğ±Ğ·Ğ¾Ñ€ ĞºĞ¾Ğ´Ğ¾Ğ²Ğ¾Ğ¹ Ğ±Ğ°Ğ·Ñ‹.

## Ğ¤Ğ¾Ñ€Ğ¼Ğ°Ñ‚ Ğ¾Ñ‚Ğ²ĞµÑ‚Ğ° (Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞ¹ markdown):

### ğŸ“ Ğ¡Ñ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ğ° Ğ¿Ñ€Ğ¾ĞµĞºÑ‚Ğ°
- ĞÑĞ½Ğ¾Ğ²Ğ½Ñ‹Ğµ Ğ´Ğ¸Ñ€ĞµĞºÑ‚Ğ¾Ñ€Ğ¸Ğ¸ Ğ¸ Ğ¸Ñ… Ğ½Ğ°Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ğµ
- ĞšĞ»ÑÑ‡ĞµĞ²Ñ‹Ğµ Ñ„Ğ°Ğ¹Ğ»Ñ‹

### ğŸ—ï¸ ĞÑ€Ñ…Ğ¸Ñ‚ĞµĞºÑ‚ÑƒÑ€Ğ°
- ĞŸĞ°Ñ‚Ñ‚ĞµÑ€Ğ½Ñ‹ Ğ¸ Ğ¿Ğ¾Ğ´Ñ…Ğ¾Ğ´Ñ‹
- Ğ Ğ°Ğ·Ğ´ĞµĞ»ĞµĞ½Ğ¸Ğµ Ğ¾Ñ‚Ğ²ĞµÑ‚ÑÑ‚Ğ²ĞµĞ½Ğ½Ğ¾ÑÑ‚Ğ¸
- Ğ—Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚Ğ¸ Ğ¼ĞµĞ¶Ğ´Ñƒ Ğ¼Ğ¾Ğ´ÑƒĞ»ÑĞ¼Ğ¸

### ğŸ’¡ Ğ¢ĞµÑ…Ğ½Ğ¾Ğ»Ğ¾Ğ³Ğ¸Ñ‡ĞµÑĞºĞ¸Ğ¹ ÑÑ‚ĞµĞº
- Ğ¯Ğ·Ñ‹Ğº Ğ¿Ñ€Ğ¾Ğ³Ñ€Ğ°Ğ¼Ğ¼Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ
- Ğ¤Ñ€ĞµĞ¹Ğ¼Ğ²Ğ¾Ñ€ĞºĞ¸ Ğ¸ Ğ±Ğ¸Ğ±Ğ»Ğ¸Ğ¾Ñ‚ĞµĞºĞ¸
- Ğ˜Ğ½ÑÑ‚Ñ€ÑƒĞ¼ĞµĞ½Ñ‚Ñ‹

### âœ… Ğ¡Ğ¸Ğ»ÑŒĞ½Ñ‹Ğµ ÑÑ‚Ğ¾Ñ€Ğ¾Ğ½Ñ‹
- Ğ¥Ğ¾Ñ€Ğ¾ÑˆĞ¸Ğµ Ğ¿Ñ€Ğ°ĞºÑ‚Ğ¸ĞºĞ¸
- ĞšĞ°Ñ‡ĞµÑÑ‚Ğ²Ğ¾ ĞºĞ¾Ğ´Ğ°

### âš ï¸ Ğ’Ğ¾Ğ·Ğ¼Ğ¾Ğ¶Ğ½Ñ‹Ğµ ÑƒĞ»ÑƒÑ‡ÑˆĞµĞ½Ğ¸Ñ
- ĞŸĞ¾Ñ‚ĞµĞ½Ñ†Ğ¸Ğ°Ğ»ÑŒĞ½Ñ‹Ğµ Ğ¿Ñ€Ğ¾Ğ±Ğ»ĞµĞ¼Ñ‹
- Ğ ĞµĞºĞ¾Ğ¼ĞµĞ½Ğ´Ğ°Ñ†Ğ¸Ğ¸

### ğŸ“Š ĞĞ±Ñ‰Ğ°Ñ Ğ¾Ñ†ĞµĞ½ĞºĞ°
ĞšÑ€Ğ°Ñ‚ĞºĞ¸Ğ¹ Ğ²Ñ‹Ğ²Ğ¾Ğ´ Ğ¾ ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ğ¸ Ğ¿Ñ€Ğ¾ĞµĞºÑ‚Ğ°.

ĞÑ‚Ğ²ĞµÑ‡Ğ°Ğ¹ Ğ½Ğ° Ñ€ÑƒÑÑĞºĞ¾Ğ¼ ÑĞ·Ñ‹ĞºĞµ. Ğ‘ÑƒĞ´ÑŒ ĞºĞ¾Ğ½ĞºÑ€ĞµÑ‚ĞµĞ½ Ğ¸ Ğ¿Ñ€Ğ°ĞºÑ‚Ğ¸Ñ‡ĞµĞ½."""

        return self.chat(
            message=prompt,
            system_prompt=system_prompt,
            use_cache=False  # ĞĞ½Ğ°Ğ»Ğ¸Ğ· Ğ¿Ñ€Ğ¾ĞµĞºÑ‚Ğ° Ğ½Ğµ ĞºÑÑˆĞ¸Ñ€ÑƒĞµĞ¼
        )


# ĞšÑÑˆ ChatAgent Ğ¿Ğ¾ Ğ¼Ğ¾Ğ´ĞµĞ»Ğ¸
_chat_agents: dict[str, ChatAgent] = {}


def get_chat_agent(
    model: Optional[str] = None,
    temperature: float = 0.3
) -> ChatAgent:
    """Ğ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµÑ‚ ÑĞºĞ·ĞµĞ¼Ğ¿Ğ»ÑÑ€ ChatAgent Ğ´Ğ»Ñ ÑƒĞºĞ°Ğ·Ğ°Ğ½Ğ½Ğ¾Ğ¹ Ğ¼Ğ¾Ğ´ĞµĞ»Ğ¸.
    
    ĞšÑÑˆĞ¸Ñ€ÑƒĞµÑ‚ Ğ°Ğ³ĞµĞ½Ñ‚Ğ¾Ğ² Ğ¿Ğ¾ Ğ¼Ğ¾Ğ´ĞµĞ»Ğ¸ Ğ´Ğ»Ñ Ğ¿ĞµÑ€ĞµĞ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ.
    
    Args:
        model: ĞœĞ¾Ğ´ĞµĞ»ÑŒ Ollama
        temperature: Ğ¢ĞµĞ¼Ğ¿ĞµÑ€Ğ°Ñ‚ÑƒÑ€Ğ° Ğ³ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ğ¸
        
    Returns:
        Ğ­ĞºĞ·ĞµĞ¼Ğ¿Ğ»ÑÑ€ ChatAgent
    """
    global _chat_agents
    cache_key = f"{model or 'default'}_{temperature}"
    
    if cache_key not in _chat_agents:
        _chat_agents[cache_key] = ChatAgent(model=model, temperature=temperature)
    
    return _chat_agents[cache_key]


def reset_chat_agent() -> None:
    """Ğ¡Ğ±Ñ€Ğ°ÑÑ‹Ğ²Ğ°ĞµÑ‚ ĞºÑÑˆ ChatAgent."""
    global _chat_agents
    _chat_agents.clear()
    logger.info("ğŸ”„ ChatAgent ĞºÑÑˆ Ğ¾Ñ‡Ğ¸Ñ‰ĞµĞ½")
