# План рефакторинга Фазы 2: Архитектурные улучшения

## Цель
Улучшить архитектуру кода, разделив большие модули на более мелкие и управляемые компоненты.

---

## Задача 1: Разделение `backend/routers/agent.py` (2278 строк)

### Проблема
- Огромный файл с множеством ответственностей
- Нарушение Single Responsibility Principle
- Дублирование кода между режимами
- Сложно тестировать и поддерживать
- 49% coverage (406 строк не покрыто)

### Структура разделения:

```
backend/routers/agent.py (основной роутер, ~200 строк)
├── backend/routers/agent_handlers/
│   ├── __init__.py
│   ├── chat_handler.py (~300 строк) - run_chat_stream
│   ├── analyze_handler.py (~200 строк) - run_analyze_stream
│   ├── workflow_handler.py (~800 строк) - run_workflow_stream
│   └── stream_manager.py (~200 строк) - управление SSE стримингом
├── backend/routers/agent_utils/
│   ├── __init__.py
│   ├── model_selector.py (~150 строк) - логика выбора моделей
│   └── task_utils.py (~100 строк) - утилиты для задач
```

### Шаги:

1. ✅ Создать структуру директорий `agent_handlers/` и `agent_utils/`
2. ✅ Вынести `run_chat_stream` в `chat_handler.py`
3. ✅ Вынести `run_analyze_stream` в `analyze_handler.py`
4. ✅ Вынести `run_workflow_stream` в `workflow_handler.py`
5. ✅ Вынести общую логику стриминга в `stream_manager.py`
6. ✅ Вынести логику выбора моделей в `model_selector.py`
7. ✅ Обновить `agent.py` для использования новых модулей
8. ✅ Обновить импорты во всех зависимых файлах
9. ✅ Добавить тесты для новых модулей
10. ✅ Проверить что все существующие тесты проходят

### Ожидаемый результат:
- `agent.py` уменьшен до ~200 строк
- Каждый handler в отдельном файле (~200-800 строк)
- Улучшена тестируемость
- Coverage улучшен

---

## Задача 2: Рефакторинг `backend/dependencies.py` (714 строк)

### Проблема
- Большой файл с дублированием кода
- Много похожих методов `get_*_agent` с одинаковой логикой
- Можно использовать generics для уменьшения дублирования

### Шаги:

1. ✅ Проанализировать дублирование в `get_*_agent` методах
2. ✅ Создать generic метод для создания агентов
3. ✅ Рефакторить существующие методы для использования generic
4. ✅ Вынести общую логику кэширования
5. ✅ Добавить тесты для generic методов
6. ✅ Проверить что все существующие тесты проходят

### Ожидаемый результат:
- Уменьшение дублирования кода на 30-40%
- Улучшенная читаемость
- Легче добавлять новые типы агентов

---

## Порядок выполнения

1. **Задача 1.1-1.6**: Создать структуру и вынести handlers
2. **Задача 1.7**: Обновить основной роутер
3. **Задача 1.8**: Обновить импорты
4. **Задача 1.9-1.10**: Тесты и проверка
5. **Задача 2**: Рефакторинг dependencies.py

---

## Критерии успеха

- ✅ `agent.py` уменьшен до <300 строк
- ✅ Каждый handler в отдельном файле
- ✅ Все существующие тесты проходят
- ✅ Coverage для agent модулей >60%
- ✅ `dependencies.py` рефакторен, дублирование уменьшено

---

## Время выполнения
Оценка: 2-3 дня
