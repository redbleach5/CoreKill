# Исправления RAG и семантического поиска

## Найденные проблемы

### 1. ❌ RAG система не указывала distance metric
**Проблема:** При создании коллекции в ChromaDB не указывался `hnsw:space`, поэтому использовался L2 distance по умолчанию, что не оптимально для текстовых эмбеддингов.

**Исправление:** Добавлен `metadata={"hnsw:space": "cosine"}` при создании коллекции в `infrastructure/rag.py`.

**Файл:** `infrastructure/rag.py`, строки 61-64

---

### 2. ❌ Неправильная интерпретация distance в _calculate_rag_confidence
**Проблема:** Комментарии и логика предполагали косинусное расстояние, но коллекция могла использовать L2. Пороги были неточными для cosine distance.

**Исправление:** 
- Обновлены комментарии с правильным описанием cosine distance
- Скорректированы пороги уверенности для cosine distance:
  - distance < 0.2 → confidence 0.95 (очень похожие)
  - distance < 0.3 → confidence 0.85 (похожие)
  - distance < 0.5 → confidence 0.7 (умеренно похожие)
  - distance < 0.7 → confidence 0.5 (слабо похожие)
  - distance >= 0.7 → confidence 0.3 (не релевантные)

**Файл:** `agents/researcher.py`, метод `_calculate_rag_confidence()`

---

### 3. ✅ MemoryAgent - формула similarity корректна
**Проверка:** Формула `similarity = 1.0 - distance` правильна для cosine distance, где:
- distance = 1 - cosine_similarity
- similarity = 1 - distance = cosine_similarity

**Улучшение:** Добавлен более подробный комментарий для ясности.

**Файл:** `agents/memory.py`, метод `find_exact_or_very_similar_task()`

---

## Проверенные компоненты

### ✅ ContextEngine (BM25)
**Статус:** Работает корректно
- Использует TF-IDF с бонусами за совпадения в именах/сигнатурах
- Правильно для лексического поиска в коде
- Не требует изменений

### ✅ CodeRetriever
**Статус:** Работает корректно
- Уже использует `metadata={"hnsw:space": "cosine"}` при создании коллекции
- Не требует изменений

---

## Результаты исправлений

1. **RAG система теперь использует cosine distance** - оптимально для семантического поиска текстов
2. **Пороги уверенности скорректированы** - более точная оценка релевантности результатов
3. **Комментарии обновлены** - ясное описание работы с cosine distance

---

## Рекомендации для тестирования

1. Проверить работу RAG на реальных запросах
2. Убедиться, что результаты поиска стали более релевантными
3. Проверить, что уверенность корректно отражает качество результатов

---

## Технические детали

### Cosine Distance в ChromaDB
- **Диапазон:** [0, 2]
- **0.0** = идентичные векторы (максимальная схожесть)
- **1.0** = ортогональные векторы (нет схожести)
- **2.0** = противоположные векторы (максимальная несхожесть)

### Преобразование в Similarity
```python
similarity = 1.0 - distance  # Для cosine distance
# similarity в диапазоне [-1, 1], но для похожих документов обычно [0.5, 1.0]
```
