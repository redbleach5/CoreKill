# План рефакторинга Фазы 1: Критические исправления

## Цель
Исправить критические ошибки и уязвимости безопасности в `error_handler.py` и `code_executor.py`.

---

## Задача 1: Исправление `error_handler.py`

### Проблема
- `sync_retry` использует `asyncio.run(asyncio.sleep(delay))` внутри синхронной функции
- Это блокирует event loop и может вызвать `RuntimeError: asyncio.run() cannot be called from a running event loop`

### Шаги:
1. ✅ Заменить `asyncio.run(asyncio.sleep(delay))` на `time.sleep(delay)` в `sync_retry`
2. ✅ Добавить импорт `import time`
3. ✅ Создать unit-тесты для `sync_retry` и `async_retry`
4. ✅ Добавить интеграционные тесты с реальными retry сценариями
5. ✅ Проверить, что исправление не сломало существующий функционал

### Ожидаемый результат:
- `sync_retry` работает корректно в синхронном контексте
- Покрытие тестами: >80%
- Все существующие тесты проходят

---

## Задача 2: Улучшение безопасности `code_executor.py`

### Проблема
- Проверка безопасности через простые строковые паттерны легко обходится
- Нет реальной изоляции (только subprocess без sandbox)
- Нет ограничений по памяти

### Шаги:

#### 2.1. AST-парсинг для проверки безопасности
1. ✅ Создать функцию `validate_code_security_ast(code: str) -> bool`
2. ✅ Использовать `ast` модуль для парсинга кода
3. ✅ Проверять запрещенные импорты через AST
4. ✅ Проверять запрещенные функции через AST
5. ✅ Проверять опасные вызовы через AST
6. ✅ Заменить строковые проверки на AST-проверки

#### 2.2. Улучшение изоляции
1. ✅ Добавить ограничения по памяти через `resource` модуль
2. ✅ Улучшить обработку временных файлов (context manager)
3. ✅ Добавить проверку на бесконечные циклы (через timeout)
4. ✅ Улучшить очистку ресурсов

#### 2.3. Тесты безопасности
1. ✅ Создать тесты для обхода старых проверок
2. ✅ Создать тесты для AST-проверок
3. ✅ Создать тесты для edge cases (большие файлы, таймауты)
4. ✅ Создать тесты для ограничений памяти

### Ожидаемый результат:
- Безопасность кода значительно улучшена (AST-проверки)
- Покрытие тестами: >70%
- Все существующие тесты проходят
- Новые тесты безопасности проходят

---

## Порядок выполнения

1. **Задача 1.1-1.2**: Исправить `error_handler.py` (замена `asyncio.run`)
2. **Задача 1.3-1.4**: Добавить тесты для `error_handler.py`
3. **Задача 1.5**: Проверить, что ничего не сломалось
4. **Задача 2.1**: Реализовать AST-парсинг для безопасности
5. **Задача 2.2**: Улучшить изоляцию и ограничения
6. **Задача 2.3**: Добавить тесты безопасности
7. **Финальная проверка**: Все тесты проходят, coverage улучшен

---

## Критерии успеха

- ✅ `error_handler.py` исправлен и покрыт тестами (>80%)
- ✅ `code_executor.py` использует AST-проверки безопасности
- ✅ Все существующие тесты проходят
- ✅ Новые тесты безопасности проходят
- ✅ Coverage для обоих модулей >70%

---

## Время выполнения
Оценка: 1-2 дня
